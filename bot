import asyncio
import logging
import urllib.parse
from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è HTML
from aiogram.utils.markdown import hbold, quote_html

# 1. –¢–û–ö–ï–ù (–ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω)
TOKEN = ""

logging.basicConfig(level=logging.INFO)
bot = Bot(token=TOKEN)
dp = Dispatcher()


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"
def get_share_keyboard(bot_username):
    bot_url = f"https://t.me/{bot_username}"
    share_text = "–ü—Ä–∏–≤–µ—Ç! –ó–∞—Ü–µ–Ω–∏ —ç—Ç–æ–≥–æ –±–æ—Ç–∞!"
    encoded_text = urllib.parse.quote(share_text)

    share_url = f"https://t.me/share/url?url={bot_url}&text={encoded_text}"

    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text="üöÄ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–≥–æ–º", url=share_url)]
        ]
    )
    return keyboard


@dp.message(CommandStart())
async def cmd_start(message: types.Message):
    # --- –ü–†–ò–ú–ï–ù–Ø–ï–ú –í–ê–® –ö–û–†–†–ï–ö–¢–ù–´–ô –ö–û–î –¢–£–¢ ---
    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –≤ –∏–º–µ–Ω–∏ –∏ —é–∑–µ—Ä–Ω–µ–π–º–µ
    full_name = quote_html(message.from_user.full_name)
    username = quote_html(message.from_user.username or "–Ω–µ—Ç_—é–∑–µ—Ä–Ω–µ–π–º–∞")
    user_id = message.from_user.id

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º hbold
    registration_text = (
        f"‚úÖ {hbold('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!')}\n\n"
        f"–ü—Ä–∏–≤–µ—Ç, {hbold(full_name)}!\n"
        f"–í–∞—à Telegram ID: <code>{user_id}</code>\n"
        f"–í–∞—à –ª–æ–≥–∏–Ω: @{username}\n\n"
        f"–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –±–æ—Ç–∞ —Å–≤–æ–∏–º –¥—Ä—É–∑—å—è–º."
    )
    # ---------------------------------------

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"
    bot_info = await bot.get_me()

    await message.answer(
        registration_text,
        parse_mode="HTML",
        reply_markup=get_share_keyboard(bot_info.username)
    )


async def main():
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    await bot.delete_webhook(drop_pending_updates=True)
    try:
        await dp.start_polling(bot)
    finally:
        await bot.session.close()


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except (KeyboardInterrupt, SystemExit):
        print("–ë–æ—Ç –≤—ã–∫–ª—é—á–µ–Ω")

